---
title: 深入理解Kotlin协程
tags:
  - 计算机-编程设计
---

![](https://cdn.weread.qq.com/weread/cover/17/YueWen_32083933/s_YueWen_32083933.jpg)


#### 1.2.1 结果传递




!!! note "笔记"

	 null的情况，执行通过回调传递任务
 
	> 结果尚未就绪，进入任务执行的状态，待结果就绪后通过回调传递给调用方；




!!! note "笔记"

	 对应下面代码null的情况 
	> 结果尚未就绪，进入任务执行的状态，待结果就绪后通过回调传递给调用方；




!!! note "笔记"

	 对应不是null的状态直接返回bitmap 
	> 结果已经就绪，可以立即提供结果。




!!! note "笔记"

	 本来就没这么设计的。这章完全没必要讲啊。有点画蛇添足了。本来简单的概念搞复杂了。 
	> 当然，通常我们不会如此设计回调API，因为这样反而让程序写起来更复杂了




#### 1.2.2 异常处理




!!! note "笔记"

	 异步逻辑同步化正是Kotlin协程要解决的问题。 


#### 1.2.3 取消响应




!!! note "笔记"

	 JDK最初提供了停止线程的API，但它很快就被废弃了，因为强行停止一个线程会导致该线程中持有的资源无法正常释放，进而出现不安全的程序状态。 


!!! note "笔记"

	 thread的stop方法
 
	> JDK最初提供了停止线程的API，但它很快就被废弃了，因为强行停止一个线程会导致该线程中持有的资源无法正常释放，进而出现不安全的程序状态。




#### 1.3.1 Future




!!! note "笔记"

	 当前调用也就被阻塞了，在所有的get返回之前，当前的调用流程会一直被限制在这段逻辑里。 


#### 1.3.2 CompletableFuture




!!! note "笔记"

	 通过它我们可以拿到异步任务的结果 


!!! note "笔记"

	 啥意思？ 
	> 但却让结果的获取脱离了主调用流程




#### 1.3.3 Promise与async/await




!!! note "笔记"

	 这些内容仅做了解即可 


#### 1.3.5 Kotlin协程




!!! note "笔记"

	 它只用了一个关键字suspend来表示挂起点，包含了异步调用和回调两层含义。我们前面提到，所有异步回调对于当前调用流程来讲都是一个挂起点，在这个挂起点我们可以做的事情非常多，既可以像async/await那样异步回调，又可以添加调度器来处理线程切换，还可以作为协程取消响应的位置，等等。 


!!! note "笔记"

	 将正常的结果返回，它的参数实际上就是bitmapSuspendable的返回值Bitmap。 


!!! note "笔记"

	 声明函数类型时充当async的作用，调用时充当await的作用。 


!!! note "笔记"

	 目的是让大家充分了解异步程序设计的发展过程。 


## 第2章 协程的基本概念




!!! note "笔记"

	 协程到底是什么 


!!! note "笔记"

	 Kotlin协程到底有什么用 


### 2.1 协程究竟是什么




!!! note "笔记"

	 在很难界定一个东西“是什么”的时候，自然很难进入知识获取过程中的“为什么”和“怎么办”这两个后续环节了。 


!!! note "笔记"

	 程的概念最核心的点就是函数或者一段程序能够被挂起，稍后再在挂起的位置恢复。挂起和恢复是开发者的程序逻辑自己控制的，协程是通过主动挂起出让运行权来实现协作的，因此它本质上就是在讨论程序控制流程的机制，这是最核心的点，任何场景下探讨协程都能落脚到挂起和恢复。 


!!! note "笔记"

	 协程与线程最大的区别在于，从任务的角度来看，线程一旦开始执行就不会暂停，直到任务结束，这个过程都是连续的。线程之间是抢占式的调度，因此不存在协作问题。 


#### 2.2.1 按调用栈分类




!!! note "笔记"

	 有栈协程的优点是可以在任意函数调用层级的任意位置挂起，并转移调度权 


!!! note "笔记"

	 有栈协程总是会给协程开辟一块栈内存，因此内存开销也大大增加，而无栈协程在内存方面就比较有优势了。 


#### 3.2.3 CPS变换




!!! note "笔记"

	 现在大家知道了原来挂起函数就是普通函数的参数中多了一个Continuation实例，难怪挂起函数总是可以调用普通函数，普通函数却不可以调用挂起函数。 


### 3.4 协程的拦截器




!!! note "笔记"

	 Kotlin协程可以通过调用挂起函数实现挂起 


!!! note "笔记"

	 可以通过Continuation的恢复调用实现恢复 


!!! note "笔记"

	 知道协程能够通过绑定一个上下文来设置一些数据来丰富协程的能力，那么我们最关心的问题来了：协程如何处理线程的调度？ 

